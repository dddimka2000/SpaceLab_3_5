<!doctype html>
<html lang="en" dir="ltr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" type="image/x-icon" th:href="@{/static/assets/images/favicon.ico}">
    <link rel="stylesheet" th:href="@{/static/assets/css/core/libs.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/assets/vendor/aos/dist/aos.css}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/hope-ui.min.css?v=2.0}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/custom.min.css?v=2.0}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/dark.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/customizer.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/rtl.min.css}"/>
    <link rel="stylesheet" th:href="@{/static/assets/css/myCss/modal.css}"/>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/assets/js/myJs/showLinkActive.js}"></script>

</head>
<body>
<div id="loading">
    <div class="loader simple-loader">
        <div class="loader-body"></div>
    </div>
</div>
<aside class="sidebar sidebar-default sidebar-white sidebar-base navs-rounded-all ">
    <div th:insert="admin/blocks/sidebar::sidebarMenu"></div>
</aside>
<main class="main-content">
    <div th:insert="admin/blocks/topPanel::topPanel"></div>
    <div class="container-fluid content-inner mt-n5 py-0">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <div class="header-title">
                            <h4 class="card-title">Создать продукт</h4>
                        </div>
                    </div>
                    <div class="card-body" th:object="${productWithChoiceDto}" id="productWithChoiceDtoId">
                        <p>Заполните данные для создания нового продукта</p>

                        <div class="form-group" id="nameProduct">
                            <div class="position-relative">
                                <label for="validationTooltip01" class="form-label">Название</label>
                                <input type="text" class="form-control" id="validationTooltip01"
                                       required="" th:field="*{name}">
                                <div th:if="${#fields.hasErrors('name')}">
                                    <div class="alert alert-danger" th:errors="*{name}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-6">
                                    <div id="nameClassification">
                                        <label class="form-label">Классификация:</label>
                                        <select class="form-select" required="" id="classificationSelect"
                                                name="classification">
                                            <option selected="" disabled="" value="">Выберите
                                                классификацию
                                            </option>
                                            <option th:each="classification : ${classifications}"
                                                    th:value="${classification}" th:text="${classification}"></option>
                                        </select>
                                    </div>
                                    <div id="nameCategory">
                                        <label for="disabledSelect" class="form-label">Категория:</label>
                                        <div id="disabledSelect">
                                            <select class="form-select" disabled="true" name="category">
                                                <option selected="" disabled="" value="">Выберите категорию</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6" id="namePrice">
                                    <label for="validationTextarea" class="form-label">Цена (грн):</label>
                                    <br>
                                    <input type="number" class="form-control" id="priceProduct"
                                           required="" th:field="*{price}" pattern="\d+(\.\d{2})?" step="0.01" min="0.01">
                                    <div th:if="${#fields.hasErrors('price')}">
                                        <div class="alert alert-danger" th:errors="*{price}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="form-group" id="nameDescription">
                            <label for="validationTextarea" class="form-label">Описание</label>
                            <textarea class="form-control" id="validationTextarea"
                                      th:field="*{description}"></textarea>
                            <div th:if="${#fields.hasErrors('description')}">
                                <div class="alert alert-danger" th:errors="*{description}">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="form-check form-group">
                            <input type="radio" class="form-check-input" id="validationFormCheck2"
                                   name="radio-stacked" required="" th:value="true">
                            <label class="form-check-label" for="validationFormCheck2">Вкл</label>
                        </div>
                        <div class="form-check form-group" id="nameStatus">
                            <input type="radio" class="form-check-input" id="validationFormCheck3"
                                   name="radio-stacked" required="" th:value="false">
                            <label class="form-check-label" for="validationFormCheck3">Выкл</label>
                            <div class="invalid-feedback">Выберите статус</div>
                            <div th:if="${#fields.hasErrors('status')}">
                                <div class="alert alert-danger" th:errors="*{status}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-0" id="nameFile">
                            <input type="file" class="form-control" required="" th:field="*{file}" id="fileProduct">
                            <div class="invalid-feedback">Добавьте изображение</div>
                            <div th:if="${#fields.hasErrors('file')}">
                                <div class="alert alert-danger" th:errors="*{file}">
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="form-group">
                            <button id="createProduct" class="btn btn-outline-dark" style="text-align: center"
                                    type="submit">Создать
                                продукт
                            </button>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>
</main>
<script>
    $(document).ready(function () {
        $("#classificationSelect").change(function () {
            var selectedValue = $(this).val();
            var contextPath = /*[[${contextPath}]]*/ '';
            console.log(contextPath);
            var url = contextPath.toString() + "create/getCategories";
            console.log(url)
            console.log(selectedValue)
            $.ajax({
                url: url,
                method: "GET",
                data: {
                    selectedValue: selectedValue
                },
                dataType: 'json',
                success: function (data) {
                    console.log(data)
                    if (Array.isArray(data)) {
                        const container = $("#disabledSelect");
                        container.empty();
                        let selectionItem = '<select class="form-select" name="category" required="">' +
                            '<option selected="" disabled="" value="">Выберите категорию</option>'
                        if (data.length > 0) {
                            data.forEach(function (category) {
                                selectionItem += '<option value="' + category + '">' + category + '</option>';
                            });
                        }
                        selectionItem += '</select>';
                        container.append(selectionItem);
                    }
                },
                error: function (error) {
                    console.log("Error:", error);
                }
            });
        })
    })
</script>
<script th:inline="javascript">
    $(document).ready(function () {
        $("#createProduct").click(function () {
            console.log("START CREATE");
            let contextPath =/*[[${contextPath}]]*/'';
            let selectedCategory = $(".form-select[name='category']").val();
            console.log(selectedCategory);
            let selectedClassification = $(".form-select[name='classification']").val();
            console.log(selectedClassification);
            let url = contextPath.toString() + "admin/products/create/validate";
            console.log(url);
            let name = $('#validationTooltip01').val();
            let price = $('#priceProduct').val();
            let description = $('#validationTextarea').val();

            const selectedValue = $('input[name="radio-stacked"]:checked').val();
            console.log(selectedValue);


            let fileInput = $('#fileProduct')[0];
            let file = fileInput.files[0];
            let formData = new FormData();
            if (file) {
                formData.append('file', file);
            }
            if (selectedValue) {
                formData.append('status', String(selectedValue));
            }
            formData.append('name', name);
            formData.append('price', String(price));
            formData.append('description', description);
            formData.append('selectedClassification', selectedClassification);
            formData.append('selectedCategory', selectedCategory);
            $.ajax({
                url: url,
                method: "POST",
                contentType: false,
                processData: false,
                data: formData,
                success: function (response) {
                    if (response.success) {
                        $(".alert.alert-danger").remove();
                        $(".alert.alert-success").remove();
                        console.log("УСПЕШНО СОЗДАН");
                        var successDiv = $("<div>").addClass("d-flex align-items-center")
                            .append(
                                $("<div>").addClass("mb-0 alert alert-success").append(
                                    $("<h5>").text("Продукт \"" + name + "\" создан."),
                                    $("<p>").text("Можете вернуться ").append(
                                        $("<a>").attr("href", /*[[@{/admin/products}]]*/).text("назад")
                                    )
                                )
                            )
                            .hide();

                        $(".header-title").append(successDiv);

                        successDiv.fadeIn("slow");
                    }


                },
                error: function (xhr, status, error) {
                    console.error("Ошибка валидации:", error);
                    let response = xhr.responseJSON;
                    let fields = response.fields;
                    console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ");
                    $(".alert.alert-success").remove();
                    $(".alert.alert-danger").remove();

                    if (fields.name) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ name");
                        $("#nameProduct").append(
                            $("<div>").addClass("alert alert-danger").text(response.fields.name)
                        );
                    }

                    if (fields.price) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ price");
                        $("#namePrice")
                            .append(
                                $("<div>").addClass("alert alert-danger").text(response.fields.price)
                            );
                    }

                    if (response.fields.description) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ description");
                        $("#nameDescription")
                            .append(
                                $("<div>").addClass("alert alert-danger").text(response.fields.description)
                            );
                    }

                    if (fields.selectedClassification) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ classification");
                        $("#nameClassification").append(
                            $("<div>").addClass("alert alert-danger").text(response.fields.selectedClassification)
                        );
                    }
                    if (fields.selectedCategory) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ category");
                        $("#nameCategory")
                            .append(
                                $("<div>").addClass("alert alert-danger").text(response.fields.selectedCategory)
                            );
                    }

                    if (response.fields.status) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ status");
                        $("#nameStatus")
                            .append(
                                $("<div>").addClass("alert alert-danger").text(response.fields.status)
                            );
                    }
                    if (response.fields.file) {
                        console.log("НЕ ПРОШЕЛ ВАЛИДАЦИЮ file");
                        $("#nameFile")
                            .append(
                                $("<div>").addClass("alert alert-danger").text(response.fields.file)
                            );
                    }
                }
            })
        })
    })
</script>

<script th:src="@{/assets/js/myJs/script.js}"></script>
<script th:src="@{/assets/js/core/libs.min.js}"></script>
<script th:src="@{/assets/js/core/external.min.js}"></script>
<script th:src="@{/assets/js/charts/widgetcharts.js}"></script>
<script th:src="@{/assets/js/charts/vectore-chart.js}"></script>
<script th:src="@{/assets/js/charts/dashboard.js}"></script>
<script th:src="@{/assets/js/plugins/fslightbox.js}"></script>
<script th:src="@{/assets/js/plugins/setting.js}"></script>
<script th:src="@{/assets/js/plugins/slider-tabs.js}"></script>
<script th:src="@{/assets/js/plugins/form-wizard.js}"></script>
<script th:src="@{/assets/vendor/aos/dist/aos.js}"></script>
<script th:src="@{/assets/js/hope-ui.js}" defer></script>

</body>
</html>